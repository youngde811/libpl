#!/usr/bin/env bash

# This script may be used by our Makefile to build the libpl debian package file.

set -o pipefail -o nounset -e

readonly progname=$(basename $0)

libdir=lib
incdir=include
pkgdir=packages
debdir=$pkgdir/debian
deblib=$debdir/libpl

major=libpl.so.1.0.0
minor=libpl.so.1
base=libpl.so

usage() {
    cat <<EOF
Usage: $progname [OPTIONS]

This script may be used by our Makefile to build the libpl debian package file.

Options:
  -h   Show this message and exit.
EOF

    exit 1
}

_error() {
    local msg="$@"

    >&2 echo "$progname: error: $msg" && exit 1
}

_warn() {
    local msg="$@"

    >&2 echo "$progname: warning: $msg"

    return 0
}

_info() {
    local msg="$@"

    echo "$progname: info: $msg"

    return 0
}

mkpackage() {
    local pkglib=usr/local/lib
    local pkginc=usr/local/include
    local pkgshare=usr/local/share/doc/libpl

    mkdir -p $deblib/$pkglib $deblib/$pkginc $deblib/$pkgshare
    cp $libdir/$major $deblib/$pkglib

    pushd $deblib/$pkglib &> /dev/null
    ln -fs $major $minor
    ln -fs $minor $base
    popd &> /dev/null

    cp $incdir/libpl.h $deblib/$pkginc
    gzip --best -cn $debdir/changelog.Debian > $deblib/$pkgshare/changelog.Debian.gz
    cp $debdir/copyright $deblib/$pkgshare

    pushd $debdir &> /dev/null
    dpkg-deb --root-owner-group --build libpl
    popd &> /dev/null

    return 0
}

# --- main() ----

while getopts "h" opt ; do
    case $opt in
        h) usage ;;
        *) usage ;;
    esac
done

shift $((OPTIND - 1))

mkpackage

exit 0

# -*- mode: shell-script; sh-shell: bash -*-
